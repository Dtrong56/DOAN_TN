# 1. Tạo file data.txt với nội dung JSON
'{"serviceId":"f109b5a6-019d-4069-872e-f919cf95f0eb","packageId":"37686f5f-25a2-4f3a-9eb2-48c66783bda8"}' | Out-File -FilePath data.txt -Encoding utf8

# 2. Tạo signedHash (SHA256 hash của data.txt, encode base64)
openssl dgst -sha256 -binary data.txt | openssl base64 -A > signedHash.txt

# 3. Tạo chữ ký nhị phân từ private.pem
openssl dgst -sha256 -sign private.pem -out signature.bin data.txt

# 4. Encode chữ ký sang Base64 để gửi đi (signatureValue)
openssl base64 -in signature.bin -out signatureValue.txt -A

# 5. Verify chữ ký bằng public.pem
openssl dgst -sha256 -verify public.pem -signature signature.bin data.txt



# Nội dung JSON đúng chuẩn
$json = '{"appendixId":"06d944a7-f16c-40ea-aac4-fe8cfc9a4de9","action":"APPROVE"}'

# Ghi ra file data.txt với UTF-8 không BOM, không thêm newline cuối
[System.IO.File]::WriteAllText("data.txt", $json, (New-Object System.Text.UTF8Encoding($false)))

# Ký bằng private.pem
openssl dgst -sha256 -sign private.pem -out signature.bin data.txt

# Encode chữ ký sang Base64
openssl base64 -in signature.bin -out signatureValue.txt -A

openssl dgst -sha256 -verify public.pem -signature signature.bin data.txt


# Sau khi đã tạo signature.bin bằng OpenSSL:
# openssl dgst -sha256 -sign private.pem -out signature.bin data.txt

# Đọc nhị phân chữ ký
$signatureBytes = [System.IO.File]::ReadAllBytes("signature.bin")

# Encode sang Base64 chuẩn
$signatureValue = [Convert]::ToBase64String($signatureBytes)

# In ra để copy vào DTO
Write-Output $signatureValue